#!/usr/bin/env ruby -W0

#########################################################################
##
## === Ruby source for #DEC_TestCases class
##
## === Written by DEIMOS Space S.L. (bolf)
##
## === Data Exchange Component
## 
## module DEC
##
#########################################################################

require 'rubygems'
require 'test/unit'
require 'fileutils'

require 'cuc/DirUtils'
require 'cuc/Log4rLoggerFactory'

require 'ctc/FTPClientCommands'
require 'dec/DEC_Environment'
require 'dec/ReadConfigDEC'
require 'dec/ReadInterfaceConfig'
require 'dec/ReadConfigOutgoing'
require 'dec/ReadConfigIncoming'


class DECTestCaseCelesTrak < Test::Unit::TestCase

   include CUC::DirUtils
   include CTC::FTPClientCommands
   include DEC

   
   # Order of the test cases execution according to defintion within code
   self.test_order = :defined
   
   @my_argv = ARGV.dup
   
   ## ------------------------------------------------------
   
   Test::Unit.at_start do      
      puts
      puts "======================================"
      puts "DEC Interface Test Cases for CelesTrak"
      puts
      puts
      puts "DO NOT EXECUTE IN THE PRODUCTION ENVIRONMENT !!!!!"
      puts
      puts "or with operational data in the archive"
      puts
      puts "THINK CAREFULLY !!! "
      puts
      puts "do you want to continue Y/n" 
      puts
      puts
      
      bBatchmode = false
            
      @my_argv.each{|arg|
         if arg == "batchmode" then
            puts "batch mode execution on"
            bBatchmode = true
            break
         end
      }
       
      if bBatchmode == false then
         c = STDIN.getc
         if c != 'Y' then
            exit(99)
         end
      end   
      
      @@conf = DEC_Environment.new
      
      @@conf.wrapper_load_config
                             
      @@conf.wrapper_print_environment
                           
      @@conf.createEnvironmentDirs
                                    
      if @@conf.wrapper_check_environment == false then
         puts "DEC environment not suited for unit tests"
         puts
         exit(99)
      end
                     
                     
      # initialize logger
                           
      loggerFactory = CUC::Log4rLoggerFactory.new("test", "#{ENV['DEC_CONFIG']}/dec_log_config.xml")
                           
      if @isDebugMode then
         loggerFactory.setDebugMode
      end
      
      @@logger = loggerFactory.getLogger
                           
      if @@logger == nil then
         puts
         puts "Error in decUnitTests::main"
         puts "Could not set up logging system !  :-("
         puts "Check DEC logs configuration under \"#{ENV['DEC_CONFIG']}/dec_log_config.xml\"" 
         puts
         puts
         exit(99)
      end
      
      
   end
   
   ## ------------------------------------------------------
   
   Test::Unit.at_exit do
      @@logger.info("End of DEC test for Celestrak")
   end
   
   ## ------------------------------------------------------
   
   ## Setup before every test-case
   ##
   def setup
      @@logger.debug("#{self.class.name.split('::').last}::#{__method__.to_s}")
                  
      decConfig   = DEC::ReadConfigDEC.instance
      reportDir   = decConfig.getReportDir

      system("\\rm -rf #{reportDir}")
      system("\\rm -rf /tmp/dec*")
      system("\\rm -rf /tmp/DEC*.log")

      cmd = "decManageDB -d"
      @@logger.debug(cmd)
      ret = system(cmd)

      cmd = "decManageDB -c"
      @@logger.debug(cmd)
      ret = system(cmd)
      
      cmd = "decValidateConfig -a"
      @@logger.debug(cmd)
      ret = system(cmd)      
      
      cmd = "decConfigInterface2DB -a CELES_D1"
      @@logger.debug(cmd)
      ret = system(cmd)
      
      cmd = "decConfigInterface2DB -a CELES_D2"
      @@logger.debug(cmd)
      ret = system(cmd)         
      
      cmd = "decConfigInterface2DB -a CELESTRAK"
      @@logger.debug(cmd)
      ret = system(cmd)

   end
   ## --------------------------------------------------------
   ## After every test case

   def teardown
      @@logger.debug("#{self.class.name.split('::').last}::#{__method__.to_s}")
   end
   ## ------------------------------------------------------

   ## -----------------------------------------------------------
   def testSFS
      @@logger.info("#{self.class.name.split('::').last}::#{__method__.to_s} START")

      cmd = "decCheckConfig -e CELESTRAK"
      @@logger.info(cmd)
      assert(system(cmd), "list from CELETRAK")
   
      cmd = "decGetFromInterface -m CELESTRAK -l"
      @@logger.info(cmd)
      assert(system(cmd), "list from CELETRAK")
   
      cmd = "decGetFromInterface -m CELESTRAK"
      @@logger.info(cmd)
      assert(system(cmd), "pull from CELESTRAK")
     
      # New iteration should not drive to a new file
      # A duplication should be detected.
      cmd = "decGetFromInterface -m CELESTRAK"
      @@logger.info(cmd)
      assert(system(cmd), "pull from CELESTRAK")

      cmd = "decStats"
      @@logger.info(cmd)
      assert(system(cmd), "pull statistics")
   
      arr = Dir["/tmp/DEC*.log"]

      @@logger.debug("Verification of log trace: SFS conversion to NAOS mission")
      cmd = "grep AUX\_001 #{arr[0]}"
      assert(system(cmd), "SFS conversion to NAOS mission traced in DEC logs in #{__method__.to_s}") 

      @@logger.debug("Verification of log trace: Duplication of short-term weather forecast")
      cmd = "grep DEC\_111 #{arr[0]}"
      assert(system(cmd), "SFS duplication traced in DEC logs in #{__method__.to_s}") 

      cmd = "grep ERROR #{arr[0]}"
      assert(!system(cmd), "ERROR found in DEC logs in #{__method__.to_s}") 
   
      @@logger.info("#{self.class.name.split('::').last}::#{__method__.to_s} END")
   end
   ## -----------------------------------------------------------
   ## ------------------------------------------------------


   def test_pull

      @@logger.info("#{self.class.name.split('::').last}::#{__method__.to_s} => START")
 
      @entityConfig     = ReadInterfaceConfig.instance
      conf              = ReadConfigIncoming.instance
      
      @finalDir         = conf.getIncomingDir("CELES_D1")
      checkDirectory(@finalDir)
      cmd = "rm -f #{@finalDir}/*"
      @@logger.debug(cmd)
      system(cmd)

      interface = "CELES_D1"

      cmd = "decGetFromInterface -m #{interface} -l"
      @@logger.debug(cmd)
      assert(system(cmd), cmd)

      sleep(2.0)

      cmd = "decGetFromInterface -m #{interface}"     
      @@logger.debug(cmd)
      assert(system(cmd), cmd)      

      sleep(5.0)

      interface = "CELES_D2"

      cmd = "decGetFromInterface -m #{interface} -l"
      @@logger.debug(cmd)
      assert(system(cmd), cmd)

      sleep(2.0)

      cmd = "decGetFromInterface -m #{interface}"
      @@logger.debug(cmd)
      assert(system(cmd), cmd)      

      sleep(5.0)

      arr = Dir["/tmp/DEC*.log"]
            
      cmd = "grep ERROR #{arr[0]}"
      @@logger.debug(cmd)
      assert(!system(cmd), "ERROR found in DEC logs in #{__method__.to_s}") 

      @@logger.info("#{self.class.name.split('::').last}::#{__method__.to_s} => END")      
      
   end
   ## ------------------------------------------------------


   ## ------------------------------------------------------


end


## ===================================================================




